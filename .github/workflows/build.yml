name: Build iOS IPA
on: workflow_dispatch
jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
        
      - name: 1. ติดตั้ง Node Modules
        run: npm install

      - name: 2. เลือก Xcode 16.1 และตั้งค่า Environment
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app
          # แก้ไขปัญหา Xcode หา Node ไม่เจอ (หัวใจของ Error 65)
          mkdir -p ios/internal
          ln -s $(command -v node) ios/internal/node
          export NODE_BINARY=$(command -v node)

      - name: 3. สร้างโฟลเดอร์ iOS (Prebuild)
        run: npx expo prebuild --platform ios --no-install

      - name: 4. ติดตั้ง CocoaPods
        run: |
          cd ios
          pod install
          cd ..

      - name: 5. บิลด์แอปแบบ Unsigned (Archive)
        # เราเพิ่มคำสั่งข้ามการตรวจสอบที่ละเอียดขึ้น
        run: |
          export NODE_BINARY=$(command -v node)
          cd ios
          WORKSPACE=$(ls | grep .xcworkspace | head -1)
          SCHEME=$(basename "$WORKSPACE" .xcworkspace)
          xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" \
          -configuration Release -sdk iphoneos \
          -destination "generic/platform=iOS" \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          AD_HOC_CODE_SIGNING_ALLOWED=YES \
          COMPILER_INDEX_STORE_ENABLE=NO \
          archive -archivePath ../app.xcarchive

      - name: 6. แพ็กไฟล์เป็น IPA
        run: |
          mkdir -p Payload
          cp -R app.xcarchive/Products/Applications/*.app Payload/
          zip -r app.ipa Payload

      - name: 7. ส่งไฟล์ออกมาให้ดาวน์โหลด
        uses: actions/upload-artifact@v4
        with:
          name: ScreenTranslator-IPA
          path: app.ipa
